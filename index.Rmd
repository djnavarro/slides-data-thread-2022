---
# NOTE: the YAML header is not used to create the title slide. The title slide 
# will be created manually as the first slide, and meta tags are specified 
# using the metathis package (see below)
title: "Doing more with data: An introduction to Arrow for R users"
output:
  xaringan::moon_reader:
    seal: false 
    lib_dir: libs
    css: ["style/xaringan-themer.css", "style/voltron-data-style.css", "style/tweaks.css"]
    nature:
      highlightStyle: solarized-dark
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
      slideNumberFormat: |
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: calc((%current% - 1) / (%total% - 1)* 100%);">
          </div>
        </div>
---


```{r load-packages, message=FALSE, echo=FALSE}
library(xaringanthemer)
library(tidyverse)
library(flair)
library(metathis)
library(arrow)
```


```{r meta, echo=FALSE}
# This is used to create all the social media tags etc. If you don't have a 
# good social preview image of your own, there's a generic one that you can use
# in this repo. Just substitute this:
#
#   image = "https://djnavarro.net/xaringan-template-voltrondata/img/social-media-preview.png",
#
# It won't show anything specific to your slides but it will show the Voltron 
# Data logo and data lake image against the usual dark green background

meta() %>%
  meta_name("github-repo" = "djnavarro/slides-data-thread-2022") %>% 
  meta_social(
    title = "Doing more with data: An introduction to Arrow for R users",
    description = "An example slide deck using the Voltron Data template for xaringan",
    url = "https://djnavarro.net/xaringan-template-voltrondata",
    image = "https://djnavarro.net/xaringan-template-voltrondata/img/title-slide-image.png",
    image_alt = "Image showing the title slide. The title in white reads 'Voltron Data template for xaringan users', with 'by Danielle Navarro' immediately underneath. The background is dark green, with the Voltron Data 'data lake' image shown in light green below the title, and the company logo shown in light green in the top right corner",
    og_type = "website",
    og_author = "Danielle Navarro",
    twitter_card_type = "summary_large_image",
    twitter_creator = "@djnavarro"
  )
```


```{r child = "style/slide-setup.Rmd"}
# Much of the set up work defining the theme is done in slide-setup.Rmd
```


class: title-slide, theme-green-maximal  <!-- title slide style -->


.center[.large[.boldface[Doing more with data: An introduction to Arrow for R users]]]  <!-- title, one line -->

.center[.midi[by Danielle Navarro]] <!-- author, one line -->
.center[.midi[[djnavarro.net/slides-data-thread-2022](http://djnavarro.net/slides-data-thread-2022)]] <!-- general info, one line -->

<!--
font-size classes (relative to normal 100%)

.larger = 200% 
.large  = 130% 
.midi   = 85% 
.small  = 70% 
.xsmall = 60% 
.tiny   = 50% 
-->


<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green

## Who is Danielle Navarro?

- Developer advocate at Voltron Data
- Data scientist and generative artist
- General nuisance in the R community
- Tweets incessantly at [@djnavarro](https://twitter.com/djnavarro)



<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green

## What is Apache Arrow?

- Toolbox for in-memory analytics
- Toolbox for larger than memory data
- Toolbox for connecting languages and hardware
- Efficient, performant, open source
- Details at [arrow.apache.org](https://arrow.apache.org)



<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green

## Who is this talk for?

- R users who want to understand Apache Arrow
- Arrow developers who want to understand the R community
- Anyone who wants to see me make a fool of myself




<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green

## What does this talk cover?

- The "big idea" behind Arrow
- An overview of the {arrow} R package
- Example analyses using NYC taxi data set (~1.7 billion rows)
- Links to additional resources!




<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-dark-maximal

## Apache Arrow: The big idea




<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## What if things were better...

- Insert the motivating example here




<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Data interchange without a standard format

```{r}
#| echo: false
#| out-width: 70%
knitr::include_graphics("img/data-interchange-1.svg")
```




<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Data interchange with a standard format

```{r}
#| echo: false
#| out-width: 70%
knitr::include_graphics("img/data-interchange-2.svg")
```




<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Columnar formats are efficient

- Self-similarity among column elements
- Filtering operations are faster




<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-dark-maximal

## Connecting R to the Arrow ecosystem


<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## How does R fit into the Arrow ecosystem?

```{r}
#| echo: false
#| out-width: 70%
knitr::include_graphics("img/arrow-ecosystem-1.svg")
```


<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## How does R fit into the Arrow ecosystem?

```{r}
#| echo: false
#| out-width: 70%
knitr::include_graphics("img/arrow-ecosystem-2.svg")
```



<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## How does R fit into the Arrow ecosystem?

```{r}
#| echo: false
#| out-width: 70%
knitr::include_graphics("img/arrow-ecosystem-3.svg")
```



<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-dark-maximal

## Connecting Arrow to the R ecosystem



<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## How does Arrow fit into the R ecosystem?

```{r}
#| echo: false
#| out-width: 70%
knitr::include_graphics("img/dplyr-backends-1.svg")
```


<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## How does Arrow fit into the R ecosystem?

```{r}
#| echo: false
#| out-width: 70%
knitr::include_graphics("img/dplyr-backends-2.svg")
```



<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## How does Arrow fit into the R ecosystem?

```{r}
#| echo: false
#| out-width: 70%
knitr::include_graphics("img/dplyr-backends-3.svg")
```



<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## How does Arrow fit into the R ecosystem?

```{r}
#| echo: false
#| out-width: 70%
knitr::include_graphics("img/dplyr-backends-4.svg")
```





<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## How do new users get started?

- Simply by typing `install.packages("arrow")`
- Links to resources go here





<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-dark-maximal

## Let's see it in action!





<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## The NYC taxi data

- Extract taxi rides from the three major airports
- Visualise the destinations by taxi zone




<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Opening a dataset

.pull-left-wide[
```{r open-nyc-taxi, eval=FALSE}
nyc_taxi <- open_dataset("~/Datasets/nyc-taxi")
nyc_taxi
```
]
--
.pull-left-wide[
.scroll-box-10[
```{r, ref.label="open-nyc-taxi", echo=FALSE}
```
]
]




<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Opening a dataset

.pull-left-wide[
```{r nyc-taxi-rows}
nyc_taxi |> 
  nrow()
```
]


<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Select and filter

.pull-left-wide[
```{r nyc-taxi-filter}
nyc_taxi |> 
  filter(year == 2019) |>
  select(matches("pickup"), matches("dropoff")) 
```
]


<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Select and filter

.pull-left-wide[
```{r nyc-taxi-filter-2}
nyc_taxi |> 
  filter(year == 2019) |>
  select(matches("pickup"), matches("dropoff")) |>
  nrow()
```
]

--

.pull-left-wide[

```{r}
nyc_taxi |> 
  nrow()
```

]






<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Spatial data as "location_id"

```{r nyc-taxi-filter-3}
nyc_taxi |> 
  filter(year == 2019) |>
  select(matches("pickup"), matches("dropoff")) |>
  head() |>
  collect()
```

<!-- 
```{r, echo=FALSE, results='asis'}
decorate_chunk("nyc-taxi-filter-3") |>
  flair_rx("head", background = "#000000") |>
  flair::knit_print.with_flair()
```
-->


<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## A secondary table

.pull-left-wide[
```{r nyc-taxi-zones}
nyc_taxi_zones <- "data/taxi_zone_lookup.csv" |> 
  read_csv_arrow() |>
  janitor::clean_names()
```
]

<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## A secondary table

.pull-left-wide[
```{r nyc-taxi-zones-2}
nyc_taxi_zones
```
]


<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## A secondary table

.pull-left-wide[
```{r nyc-taxi-zones-3}
nyc_taxi_zones |> 
  filter(str_detect(zone, "Airport"))
```
]


<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Extract airport zones

.pull-left-wide[
```{r nyc-taxi-zones-4}
airport_zones <- nyc_taxi_zones |> 
  filter(str_detect(zone, "Airport")) |>
  pull(location_id)

airport_zones
```
]


<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Mutate, filter, and select

.pull-left[
```{r nyc-taxi-filter-4, eval=FALSE}
nyc_taxi |> 
  mutate(
    pickup_airport = 
      pickup_location_id %in% airport_zones
  ) |>
  filter(pickup_airport == TRUE) |>
  select(
    matches("datetime"), 
    matches("location_id")
  )
```
]
--
.pull-right[
.scroll-output[
```{r, ref.label="nyc-taxi-filter-4", echo=FALSE}
```
]
]



<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Mutate, filter, and select

.pull-left[
```{r nyc-taxi-filter-5}
nyc_taxi |> 
  mutate(
    pickup_airport = 
      pickup_location_id %in% airport_zones
  ) |>
  filter(pickup_airport == TRUE) |>
  select(
    matches("datetime"), 
    matches("location_id")
  ) |> 
  nrow()
```
]






<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Database joins

.pull-left[
```{r nyc-taxi-join, eval=FALSE}
nyc_taxi |> 
  filter(
    pickup_location_id %in% airport_zones
  ) |>
  select(
    matches("datetime"), 
    matches("location_id")
  ) |> 
  left_join(
    nyc_taxi_zones,
    by = c(
      "dropoff_location_id" = "location_id"
    )
  )
```
]
--
.pull-right[
.scroll-output[
```{r, ref.label="nyc-taxi-join", echo=FALSE}
```
]
]

<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Database joins

.pull-left[
```{r nyc-taxi-join-2, eval=FALSE}
nyc_taxi |> 
  filter(
    pickup_location_id %in% airport_zones
  ) |>
  select(
    matches("datetime"), 
    matches("location_id")
  ) |> 
  left_join(
    nyc_taxi_zones,
    by = c(
      "dropoff_location_id" = "location_id"
    )
  ) |>
  collect()
```
]


<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Wait, this errors????

.pull-left[
```{r, ref.label="nyc-taxi-join-2", echo=TRUE, eval=FALSE}
```
]

.pull-right[
.scroll-output[
```{r, ref.label="nyc-taxi-join-2", echo=FALSE, error=TRUE, warning=FALSE}
```
]
]

<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Wait, this errors????

.pull-left[
```{r, ref.label="nyc-taxi-join-2", echo=TRUE, eval=FALSE}
```
]

.pull-right[
- `location_id`: 
    - 32-bit integer
- `dropoff_location_id`: 
    - 64-bit integer
- Needs to be handled explicitly
- May be new to some R users
]



<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Explicit type casting

.pull-left[
```{r type-casting, eval=FALSE}
nyc_taxi_zones_2 <- nyc_taxi_zones |>
  transmute(
    dropoff_location_id = location_id, 
    dropoff_borough = borough,
    dropoff_zone = zone) |>
  as_arrow_table(
    schema = schema(
      dropoff_location_id = int64(),
      dropoff_borough = utf8(),
      dropoff_zone = utf8()
    )
  )

nyc_taxi_zones_2
```
]
--
.pull-right[
.scroll-output[
```{r, ref.label="type-casting", echo=FALSE}
```
]
]





<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Now it all works...

.pull-left[
```{r nyc-taxi-join-3, eval=FALSE}
nyc_taxi |> 
  filter(
    pickup_location_id %in% airport_zones
  ) |>
  select(
    matches("datetime"), 
    matches("location_id")
  ) |> 
  left_join(nyc_taxi_zones_2) |>
  collect()
```
]
--
.pull-right[
.scroll-output[
```{r, ref.label="nyc-taxi-join-3", echo=FALSE, error=TRUE, warning=FALSE}
```
]
]




<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Aggregate by zone

.pull-left[
```{r nyc-taxi-join-4, eval=FALSE}
nyc_taxi_zone_counts <- nyc_taxi |> 
  filter(
    pickup_location_id %in% airport_zones
  ) |>
  select(
    matches("datetime"), 
    matches("location_id")
  ) |> 
  left_join(nyc_taxi_zones_2) |>
  count(dropoff_zone) |>
  arrange(desc(n)) |>
  collect()

nyc_taxi_zone_counts
```
]

.pull-right[
.scroll-output[
```{r, ref.label="nyc-taxi-join-4", echo=FALSE, error=TRUE, warning=FALSE}
```
]
]



<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## ... and a tiny bit more work ...

```{r hack, echo=FALSE}
theme_custom <- function() {
  theme_voltron_light() + 
  theme(
    panel.grid = element_blank(), 
    legend.background = element_rect(
      colour = "transparent", 
      fill = "transparent"
    ), 
    axis.text.x = element_text(angle = 90, vjust = .5)
  )
}
```

.pull-left-wide[
```{r nyc-taxi-spatial, eval=FALSE}
nyc_taxi_zones_spatial <- "data/taxi_zones/taxi_zones.shp" |> 
  sf::read_sf() |>
  janitor::clean_names()

nyc_taxi_zones_spatial |> 
  left_join(nyc_taxi_zone_counts,
            by = c("zone" = "dropoff_zone")) |>
  ggplot(aes(fill = n)) + 
  geom_sf(size = .1) + 
  scale_fill_distiller(
    name = "Number of trips",
    labels = scales::label_comma(),
    direction = 1
  ) + 
  theme_custom()
```
]

<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Produces a nice visualisation

```{r taxi-zones-map, ref.label="nyc-taxi-spatial", out.width=750, echo=FALSE}
```









<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-dark-maximal

## Getting a deeper understanding






<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## Where does the new R user go?

- Cookbooks
- Blogposts
- Workshops



<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-green-minimal

## How can the Arrow community help?

- Looking at our docs from a new user perspective
- Putting together novice friendly tutorials
- Being visible and helpful where we can!






<!----------------------------- SLIDE BREAK ----------------------------->
---

class: theme-dark-maximal

## Making connections with data! 

.pull-left[
- Apache Arrow is cool
- Data wrangling in R is cool
- {arrow} brings them together
]

.pull-right[
<ol class="fa-ul">
  <li><span class="fa-li"><i class="fa fa-twitter"></i></span>twitter.com/djnavarro</li>
  <li><span class="fa-li"><i class="fa fa-github"></i></span>github.com/djnavarro</li>
  <li><span class="fa-li"><i class="fa fa-globe"></i></span>djnavarro.net</li>
</ol>
]


