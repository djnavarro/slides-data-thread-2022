<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Doing more with data: An introduction to Arrow for R users</title>
    <meta charset="utf-8" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <meta name="github-repo" content="djnavarro/slides-data-thread-2022"/>
    <meta name="twitter:title" content="Doing more with data: An introduction to Arrow for R users"/>
    <meta name="twitter:description" content="An example slide deck using the Voltron Data template for xaringan"/>
    <meta name="twitter:url" content="https://djnavarro.net/xaringan-template-voltrondata"/>
    <meta name="twitter:image" content="https://djnavarro.net/xaringan-template-voltrondata/img/title-slide-image.png"/>
    <meta name="twitter:image:alt" content="Image showing the title slide. The title in white reads &#39;Voltron Data template for xaringan users&#39;, with &#39;by Danielle Navarro&#39; immediately underneath. The background is dark green, with the Voltron Data &#39;data lake&#39; image shown in light green below the title, and the company logo shown in light green in the top right corner"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:creator" content="@djnavarro"/>
    <meta name="twitter:site" content="@djnavarro"/>
    <meta property="og:title" content="Doing more with data: An introduction to Arrow for R users"/>
    <meta property="og:description" content="An example slide deck using the Voltron Data template for xaringan"/>
    <meta property="og:url" content="https://djnavarro.net/xaringan-template-voltrondata"/>
    <meta property="og:image" content="https://djnavarro.net/xaringan-template-voltrondata/img/title-slide-image.png"/>
    <meta property="og:image:alt" content="Image showing the title slide. The title in white reads &#39;Voltron Data template for xaringan users&#39;, with &#39;by Danielle Navarro&#39; immediately underneath. The background is dark green, with the Voltron Data &#39;data lake&#39; image shown in light green below the title, and the company logo shown in light green in the top right corner"/>
    <meta property="og:type" content="website"/>
    <meta property="og:locale" content="en_US"/>
    <meta property="article:author" content="Danielle Navarro"/>
    <link href="libs/font-awesome/css/all.css" rel="stylesheet" />
    <link href="libs/font-awesome/css/v4-shims.css" rel="stylesheet" />
    <link rel="stylesheet" href="style/xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="style/voltron-data-style.css" type="text/css" />
    <link rel="stylesheet" href="style/tweaks.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">












layout: true

&lt;div class="my-footer"&gt;
&lt;span&gt;
  &lt;!-- 
  You could put a footer link in here, which I used to do for a lot of my
  other slide decks, but it probably doesn't work well with this theme
  --&gt;
&lt;/span&gt;
&lt;/div&gt; 

---


class: title-slide, theme-green-maximal  &lt;!-- title slide style --&gt;


.center[.large[.boldface[Doing more with data: An introduction to Arrow for R users]]]  &lt;!-- title, one line --&gt;

.center[.midi[by Danielle Navarro]] &lt;!-- author, one line --&gt;
.center[.midi[[djnavarro.net/slides-data-thread-2022](http://djnavarro.net/slides-data-thread-2022)]] &lt;!-- general info, one line --&gt;

&lt;!--
font-size classes (relative to normal 100%)

.larger = 200% 
.large  = 130% 
.midi   = 85% 
.small  = 70% 
.xsmall = 60% 
.tiny   = 50% 
--&gt;


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green

## Who is Danielle Navarro?

- Developer advocate at Voltron Data
- Data scientist and generative artist
- General nuisance in the R community
- Tweets incessantly at [@djnavarro](https://twitter.com/djnavarro)



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green

## What is Apache Arrow?

- Toolbox for in-memory analytics
- Toolbox for larger than memory data
- Toolbox for connecting languages and hardware
- Efficient, performant, open source
- Details at [arrow.apache.org](https://arrow.apache.org)



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green

## Who is this talk for?

- R users who want to understand Apache Arrow
- Arrow developers who want to understand the R community
- Anyone who wants to see me make a fool of myself




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green

## What does this talk cover?

- The "big idea" behind Arrow
- An overview of the {arrow} R package
- Example analyses using NYC taxi data set (~1.7 billion rows)
- Links to additional resources!




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-dark-maximal

## Apache Arrow

&gt; A multi-language toolbox &lt;br&gt;
&gt; for accelerated data interchange &lt;br&gt; 
&gt; and in-memory processing




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Data interchange without standardization

&lt;img src="img/data-interchange-1.svg" width="70%" /&gt;




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Data interchange with standardization

&lt;img src="img/data-interchange-2.svg" width="70%" /&gt;




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Efficient in-memory processing

&lt;img src="img/simd-1.svg" width="70%" /&gt;



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Efficient in-memory processing

&lt;img src="img/simd-2.svg" width="70%" /&gt;



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Efficient in-memory processing

&lt;img src="img/simd-3.svg" width="70%" /&gt;



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Efficient in-memory processing

&lt;img src="img/simd-4.svg" width="70%" /&gt;






&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-dark-maximal

## Connecting R to the Arrow ecosystem


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Where does R fit (in Arrow)?

&lt;img src="img/arrow-ecosystem-1.svg" width="70%" /&gt;


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Where does R fit (in Arrow)?

&lt;img src="img/arrow-ecosystem-2.svg" width="70%" /&gt;



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Where does R fit (in Arrow)?

&lt;img src="img/arrow-ecosystem-3.svg" width="70%" /&gt;



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-dark-maximal

## Connecting Arrow to the R ecosystem



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Where does Arrow fit (in R)?

- Analyze, process, and write multi-file parquet, csv, S3 buckets, ...
--

- Larger-than-memory data sets
--

- ... many other things...
--

- Analyze Arrow data using dplyr verbs



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Where does Arrow fit (in R)?

&lt;img src="img/dplyr-backends-1.svg" width="70%" /&gt;


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## dplyr connects to an Arrow backend

&lt;img src="img/dplyr-backends-2.svg" width="70%" /&gt;



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## dplyr connects to an Arrow backend

&lt;img src="img/dplyr-backends-3.svg" width="70%" /&gt;



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## dplyr connects to an Arrow backend

&lt;img src="img/dplyr-backends-4.svg" width="70%" /&gt;





&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## How do new users get started?

- Install arrow by typing `install.packages("arrow")`
- To use dplyr pipelines both arrow and dplyr must be loaded


```r
library(arrow)
library(dplyr)
```

--

- Installation resources:
  - [arrow.apache.org/docs/r](https://arrow.apache.org/docs/r/)
  - [blog.djnavarro.net/starting-apache-arrow-in-r](https://blog.djnavarro.net/starting-apache-arrow-in-r/)





&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-dark-maximal

## Let's see it in action!





&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-dark-minimal
background-image: url("img/redd-Ra8VlGo0tyI-unsplash.jpg")
background-size: cover
background-repeat: no-repeat
background-position: left

## Step 1: Get data

&lt;div class="my-footer"&gt;
&lt;span&gt;
&lt;a style="color:#f97b64; background-color: #22222288; padding: 5px" href="https://unsplash.com/photos/Ra8VlGo0tyI"&gt;&lt;b&gt;Image freely available courtesy of Redd, via Unsplash&lt;/b&gt;&lt;/a&gt;
&lt;/span&gt;
&lt;/div&gt; 



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## The NYC taxi data

- The data set:

  - Original data from the New York City Taxi and Limosine Service
  - Pickup and dropoff locations and time, fees, tips, etc
  - Approximately ~1.7 billion rows in a single table, from 2009 to 2022
  
--

- The case study:
  - Extract taxi rides from the three major airports
  - Visualise the destinations by taxi zone

&lt;!-- https://www1.nyc.gov/site/tlc/about/tlc-trip-record-data.page --&gt;


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Obtaining the data

.pull-left-wide[

```r
library(arrow)

copy_files(
  from = s3_bucket("ursa-labs-taxi-data-v2"),
  to = "~/Datasets/nyc-taxi"
)
```

- Warning: this is 69GB in total
- It takes a long time!
]


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Obtaining the data

.pull-left[

- NYC taxi is a multi-file data set
  - 158 separate parquet files
  - Partitioned by year and month


```r
fs::dir_tree("~/Datasets/nyc-taxi/")
```
]

--

.pull-right[
.scroll-box-14[

```
## ~/Datasets/nyc-taxi/
## ├── year=2009
## │   ├── month=1
## │   │   └── part-0.parquet
## │   ├── month=10
## │   │   └── part-0.parquet
## │   ├── month=11
## │   │   └── part-0.parquet
## │   ├── month=12
## │   │   └── part-0.parquet
## │   ├── month=2
## │   │   └── part-0.parquet
## │   ├── month=3
## │   │   └── part-0.parquet
## │   ├── month=4
## │   │   └── part-0.parquet
## │   ├── month=5
## │   │   └── part-0.parquet
## │   ├── month=6
## │   │   └── part-0.parquet
## │   ├── month=7
## │   │   └── part-0.parquet
## │   ├── month=8
## │   │   └── part-0.parquet
## │   └── month=9
## │       └── part-0.parquet
## ├── year=2010
## │   ├── month=1
## │   │   └── part-0.parquet
## │   ├── month=10
## │   │   └── part-0.parquet
## │   ├── month=11
## │   │   └── part-0.parquet
## │   ├── month=12
## │   │   └── part-0.parquet
## │   ├── month=2
## │   │   └── part-0.parquet
## │   ├── month=3
## │   │   └── part-0.parquet
## │   ├── month=4
## │   │   └── part-0.parquet
## │   ├── month=5
## │   │   └── part-0.parquet
## │   ├── month=6
## │   │   └── part-0.parquet
## │   ├── month=7
## │   │   └── part-0.parquet
## │   ├── month=8
## │   │   └── part-0.parquet
## │   └── month=9
## │       └── part-0.parquet
## ├── year=2011
## │   ├── month=1
## │   │   └── part-0.parquet
## │   ├── month=10
## │   │   └── part-0.parquet
## │   ├── month=11
## │   │   └── part-0.parquet
## │   ├── month=12
## │   │   └── part-0.parquet
## │   ├── month=2
## │   │   └── part-0.parquet
## │   ├── month=3
## │   │   └── part-0.parquet
## │   ├── month=4
## │   │   └── part-0.parquet
## │   ├── month=5
## │   │   └── part-0.parquet
## │   ├── month=6
## │   │   └── part-0.parquet
## │   ├── month=7
## │   │   └── part-0.parquet
## │   ├── month=8
## │   │   └── part-0.parquet
## │   └── month=9
## │       └── part-0.parquet
## ├── year=2012
## │   ├── month=1
## │   │   └── part-0.parquet
## │   ├── month=10
## │   │   └── part-0.parquet
## │   ├── month=11
## │   │   └── part-0.parquet
## │   ├── month=12
## │   │   └── part-0.parquet
## │   ├── month=2
## │   │   └── part-0.parquet
## │   ├── month=3
## │   │   └── part-0.parquet
## │   ├── month=4
## │   │   └── part-0.parquet
## │   ├── month=5
## │   │   └── part-0.parquet
## │   ├── month=6
## │   │   └── part-0.parquet
## │   ├── month=7
## │   │   └── part-0.parquet
## │   ├── month=8
## │   │   └── part-0.parquet
## │   └── month=9
## │       └── part-0.parquet
## ├── year=2013
## │   ├── month=1
## │   │   └── part-0.parquet
## │   ├── month=10
## │   │   └── part-0.parquet
## │   ├── month=11
## │   │   └── part-0.parquet
## │   ├── month=12
## │   │   └── part-0.parquet
## │   ├── month=2
## │   │   └── part-0.parquet
## │   ├── month=3
## │   │   └── part-0.parquet
## │   ├── month=4
## │   │   └── part-0.parquet
## │   ├── month=5
## │   │   └── part-0.parquet
## │   ├── month=6
## │   │   └── part-0.parquet
## │   ├── month=7
## │   │   └── part-0.parquet
## │   ├── month=8
## │   │   └── part-0.parquet
## │   └── month=9
## │       └── part-0.parquet
## ├── year=2014
## │   ├── month=1
## │   │   └── part-0.parquet
## │   ├── month=10
## │   │   └── part-0.parquet
## │   ├── month=11
## │   │   └── part-0.parquet
## │   ├── month=12
## │   │   └── part-0.parquet
## │   ├── month=2
## │   │   └── part-0.parquet
## │   ├── month=3
## │   │   └── part-0.parquet
## │   ├── month=4
## │   │   └── part-0.parquet
## │   ├── month=5
## │   │   └── part-0.parquet
## │   ├── month=6
## │   │   └── part-0.parquet
## │   ├── month=7
## │   │   └── part-0.parquet
## │   ├── month=8
## │   │   └── part-0.parquet
## │   └── month=9
## │       └── part-0.parquet
## ├── year=2015
## │   ├── month=1
## │   │   └── part-0.parquet
## │   ├── month=10
## │   │   └── part-0.parquet
## │   ├── month=11
## │   │   └── part-0.parquet
## │   ├── month=12
## │   │   └── part-0.parquet
## │   ├── month=2
## │   │   └── part-0.parquet
## │   ├── month=3
## │   │   └── part-0.parquet
## │   ├── month=4
## │   │   └── part-0.parquet
## │   ├── month=5
## │   │   └── part-0.parquet
## │   ├── month=6
## │   │   └── part-0.parquet
## │   ├── month=7
## │   │   └── part-0.parquet
## │   ├── month=8
## │   │   └── part-0.parquet
## │   └── month=9
## │       └── part-0.parquet
## ├── year=2016
## │   ├── month=1
## │   │   └── part-0.parquet
## │   ├── month=10
## │   │   └── part-0.parquet
## │   ├── month=11
## │   │   └── part-0.parquet
## │   ├── month=12
## │   │   └── part-0.parquet
## │   ├── month=2
## │   │   └── part-0.parquet
## │   ├── month=3
## │   │   └── part-0.parquet
## │   ├── month=4
## │   │   └── part-0.parquet
## │   ├── month=5
## │   │   └── part-0.parquet
## │   ├── month=6
## │   │   └── part-0.parquet
## │   ├── month=7
## │   │   └── part-0.parquet
## │   ├── month=8
## │   │   └── part-0.parquet
## │   └── month=9
## │       └── part-0.parquet
## ├── year=2017
## │   ├── month=1
## │   │   └── part-0.parquet
## │   ├── month=10
## │   │   └── part-0.parquet
## │   ├── month=11
## │   │   └── part-0.parquet
## │   ├── month=12
## │   │   └── part-0.parquet
## │   ├── month=2
## │   │   └── part-0.parquet
## │   ├── month=3
## │   │   └── part-0.parquet
## │   ├── month=4
## │   │   └── part-0.parquet
## │   ├── month=5
## │   │   └── part-0.parquet
## │   ├── month=6
## │   │   └── part-0.parquet
## │   ├── month=7
## │   │   └── part-0.parquet
## │   ├── month=8
## │   │   └── part-0.parquet
## │   └── month=9
## │       └── part-0.parquet
## ├── year=2018
## │   ├── month=1
## │   │   └── part-0.parquet
## │   ├── month=10
## │   │   └── part-0.parquet
## │   ├── month=11
## │   │   └── part-0.parquet
## │   ├── month=12
## │   │   └── part-0.parquet
## │   ├── month=2
## │   │   └── part-0.parquet
## │   ├── month=3
## │   │   └── part-0.parquet
## │   ├── month=4
## │   │   └── part-0.parquet
## │   ├── month=5
## │   │   └── part-0.parquet
## │   ├── month=6
## │   │   └── part-0.parquet
## │   ├── month=7
## │   │   └── part-0.parquet
## │   ├── month=8
## │   │   └── part-0.parquet
## │   └── month=9
## │       └── part-0.parquet
## ├── year=2019
## │   ├── month=1
## │   │   └── part-0.parquet
## │   ├── month=10
## │   │   └── part-0.parquet
## │   ├── month=11
## │   │   └── part-0.parquet
## │   ├── month=12
## │   │   └── part-0.parquet
## │   ├── month=2
## │   │   └── part-0.parquet
## │   ├── month=3
## │   │   └── part-0.parquet
## │   ├── month=4
## │   │   └── part-0.parquet
## │   ├── month=5
## │   │   └── part-0.parquet
## │   ├── month=6
## │   │   └── part-0.parquet
## │   ├── month=7
## │   │   └── part-0.parquet
## │   ├── month=8
## │   │   └── part-0.parquet
## │   └── month=9
## │       └── part-0.parquet
## ├── year=2020
## │   ├── month=1
## │   │   └── part-0.parquet
## │   ├── month=10
## │   │   └── part-0.parquet
## │   ├── month=11
## │   │   └── part-0.parquet
## │   ├── month=12
## │   │   └── part-0.parquet
## │   ├── month=2
## │   │   └── part-0.parquet
## │   ├── month=3
## │   │   └── part-0.parquet
## │   ├── month=4
## │   │   └── part-0.parquet
## │   ├── month=5
## │   │   └── part-0.parquet
## │   ├── month=6
## │   │   └── part-0.parquet
## │   ├── month=7
## │   │   └── part-0.parquet
## │   ├── month=8
## │   │   └── part-0.parquet
## │   └── month=9
## │       └── part-0.parquet
## ├── year=2021
## │   ├── month=1
## │   │   └── part-0.parquet
## │   ├── month=10
## │   │   └── part-0.parquet
## │   ├── month=11
## │   │   └── part-0.parquet
## │   ├── month=12
## │   │   └── part-0.parquet
## │   ├── month=2
## │   │   └── part-0.parquet
## │   ├── month=3
## │   │   └── part-0.parquet
## │   ├── month=4
## │   │   └── part-0.parquet
## │   ├── month=5
## │   │   └── part-0.parquet
## │   ├── month=6
## │   │   └── part-0.parquet
## │   ├── month=7
## │   │   └── part-0.parquet
## │   ├── month=8
## │   │   └── part-0.parquet
## │   └── month=9
## │       └── part-0.parquet
## └── year=2022
##     ├── month=1
##     │   └── part-0.parquet
##     └── month=2
##         └── part-0.parquet
```
]
]




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Opening a dataset

.pull-left-wide[

```r
nyc_taxi &lt;- open_dataset("~/Datasets/nyc-taxi")
nyc_taxi
```
]
--
.pull-left-wide[
.scroll-box-10[

```
## FileSystemDataset with 158 Parquet files
## vendor_name: string
## pickup_datetime: timestamp[ms]
## dropoff_datetime: timestamp[ms]
## passenger_count: int64
## trip_distance: double
## pickup_longitude: double
## pickup_latitude: double
## rate_code: string
## store_and_fwd: string
## dropoff_longitude: double
## dropoff_latitude: double
## payment_type: string
## fare_amount: double
## extra: double
## mta_tax: double
## tip_amount: double
## tolls_amount: double
## total_amount: double
## improvement_surcharge: double
## congestion_surcharge: double
## pickup_location_id: int64
## dropoff_location_id: int64
## year: int32
## month: int32
```
]
]



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Opening a dataset

.pull-left-wide[
- Is it really 1.7 billion rows?
]
--
.pull-left-wide[
- Absolutely yes!

```r
nyc_taxi |&gt; 
  nrow()
```

```
## [1] 1672590319
```
]




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Opening a dataset

.pull-left-wide[
- Is it really 1.7 billion rows? (Yes)
- Is all this data somehow loaded in R?
]
--
.pull-left-wide[
- Absolutely not!

```r
nyc_taxi |&gt; 
  lobstr::obj_size()
```

```
## 261,088 B
```
]




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Opening a dataset

.pull-left-wide[
- Is it really 1.7 billion rows? (Yes)
- Is all this data somehow loaded in R? (No)
- Is there a trick? (Yes: read files as needed)
]


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Using dplyr verbs: Select and filter

.pull-left-wide[

```r
nyc_taxi |&gt; 
  filter(year == 2019) |&gt;
  select(matches("pickup"), matches("dropoff")) 
```
]
--

.pull-left-wide[

```
## FileSystemDataset (query)
## pickup_datetime: timestamp[ms]
## pickup_longitude: double
## pickup_latitude: double
## pickup_location_id: int64
## dropoff_datetime: timestamp[ms]
## dropoff_longitude: double
## dropoff_latitude: double
## dropoff_location_id: int64
## 
## * Filter: (year == 2019)
## See $.data for the source Arrow object
```
]



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Using dplyr verbs: Select and filter

.pull-left-wide[

```r
nyc_taxi |&gt; 
  filter(year == 2019) |&gt;
  select(matches("pickup"), matches("dropoff")) 
```
]

.pull-left-wide[
- The output is a unevaluated query
]




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Check before you `collect()`!

.pull-left-wide[

```r
nyc_taxi |&gt; 
  filter(year == 2019) |&gt;
  select(matches("pickup"), matches("dropoff")) |&gt;
  nrow()
```

```
## [1] 84393604
```
]


.pull-left-wide[

- 84 million rows is more than I want
- Perhaps better to collect a subset...
  - Calling `compute()` evaluates in Arrow
  - Calling `collect()` evaluates and returns to R
]




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Use `head()` to collect a tiny subset


```r
nyc_taxi |&gt; 
  filter(year == 2019) |&gt;
  select(matches("pickup"), matches("dropoff")) |&gt;
  head() |&gt;
  collect()
```

- Only collects the first few rows
- Can be evaluated efficiently


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Aha! Spatial information in "location_id"


```r
nyc_taxi |&gt; 
  filter(year == 2019) |&gt;
  select(matches("pickup"), matches("dropoff")) |&gt;
  head() |&gt;
  collect()
```

```
## # A tibble: 6 × 8
##   pickup_datetime     pickup_longitude pickup_latitude pickup_location_id
##   &lt;dttm&gt;                         &lt;dbl&gt;           &lt;dbl&gt;              &lt;int&gt;
## 1 2019-12-01 22:45:18               NA              NA                114
## 2 2019-12-01 22:04:02               NA              NA                263
## 3 2019-12-01 22:20:38               NA              NA                 75
## 4 2019-12-01 22:46:36               NA              NA                 75
## 5 2019-12-01 22:13:05               NA              NA                107
## 6 2019-12-01 22:32:19               NA              NA                231
## # … with 4 more variables: dropoff_datetime &lt;dttm&gt;, dropoff_longitude &lt;dbl&gt;,
## #   dropoff_latitude &lt;dbl&gt;, dropoff_location_id &lt;int&gt;
```

&lt;!-- 

&lt;code class ='r hljs remark-code'&gt;nyc_taxi |&gt; &lt;br&gt;&amp;nbsp;&amp;nbsp;filter(year == 2019) |&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;select(matches("pickup"), matches("dropoff")) |&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&lt;span style='background-color:#000000'&gt;head&lt;/span&gt;() |&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;collect()&lt;/code&gt;

```

## # A tibble: 6 × 8
##   pickup_datetime     pickup_longitude pickup_latitude pickup_location_id
##   &lt;dttm&gt;                         &lt;dbl&gt;           &lt;dbl&gt;              &lt;int&gt;
## 1 2019-12-01 22:45:18               NA              NA                114
## 2 2019-12-01 22:04:02               NA              NA                263
## 3 2019-12-01 22:20:38               NA              NA                 75
## 4 2019-12-01 22:46:36               NA              NA                 75
## 5 2019-12-01 22:13:05               NA              NA                107
## 6 2019-12-01 22:32:19               NA              NA                231
## # … with 4 more variables: dropoff_datetime &lt;dttm&gt;, dropoff_longitude &lt;dbl&gt;,
## #   dropoff_latitude &lt;dbl&gt;, dropoff_location_id &lt;int&gt;

```
--&gt;




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-dark-minimal
background-image: url("img/paolo-chiabrando-1fBiGUm_jbw-unsplash.jpg")
background-size: cover
background-repeat: no-repeat
background-position: left


## Step 2: Find airports

&lt;div class="my-footer"&gt;
&lt;span&gt;
&lt;a style="color:#f97b64; background-color: #22222288; padding: 5px" href="https://unsplash.com/photos/1fBiGUm_jbw"&gt;&lt;b&gt;Image freely available courtesy of Paolo Chiabrando, via Unsplash&lt;/b&gt;&lt;/a&gt;
&lt;/span&gt;
&lt;/div&gt; 


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## A secondary table

- NYC TLC also supplies auxiliary files in the source data
- One file is a CSV with extra information about taxi zones
- It's a small table, we can handle it natively in R:

.pull-left-wide[

```r
nyc_taxi_zones &lt;- "data/taxi_zone_lookup.csv" |&gt; 
  read_csv_arrow() |&gt;
  janitor::clean_names()
```
]

&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## A secondary table

.pull-left-wide[

```r
nyc_taxi_zones
```

```
## # A tibble: 265 × 4
##    location_id borough       zone                    service_zone
##          &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;                   &lt;chr&gt;       
##  1           1 EWR           Newark Airport          EWR         
##  2           2 Queens        Jamaica Bay             Boro Zone   
##  3           3 Bronx         Allerton/Pelham Gardens Boro Zone   
##  4           4 Manhattan     Alphabet City           Yellow Zone 
##  5           5 Staten Island Arden Heights           Boro Zone   
##  6           6 Staten Island Arrochar/Fort Wadsworth Boro Zone   
##  7           7 Queens        Astoria                 Boro Zone   
##  8           8 Queens        Astoria Park            Boro Zone   
##  9           9 Queens        Auburndale              Boro Zone   
## 10          10 Queens        Baisley Park            Boro Zone   
## # … with 255 more rows
```
]


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## A secondary table

.pull-left-wide[

```r
nyc_taxi_zones |&gt; 
  filter(str_detect(zone, "Airport"))
```

```
## # A tibble: 3 × 4
##   location_id borough zone              service_zone
##         &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;             &lt;chr&gt;       
## 1           1 EWR     Newark Airport    EWR         
## 2         132 Queens  JFK Airport       Airports    
## 3         138 Queens  LaGuardia Airport Airports
```
]


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Extract airport zones

.pull-left-wide[

```r
airport_zones &lt;- nyc_taxi_zones |&gt; 
  filter(str_detect(zone, "Airport")) |&gt;
  pull(location_id)

airport_zones
```

```
## [1]   1 132 138
```
]




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-dark-minimal
background-image: url("img/helena-lopes-bunLmHpu1hg-unsplash.jpg")
background-size: cover
background-repeat: no-repeat
background-position: left

## Step 3: Wrangle data

&lt;div class="my-footer"&gt;
&lt;span&gt;
&lt;a style="color:#f97b64; background-color: #22222288; padding: 5px" href="https://unsplash.com/photos/bunLmHpu1hg"&gt;&lt;b&gt;Image freely available courtesy of Helena Lopes, via Unsplash&lt;/b&gt;&lt;/a&gt;
&lt;/span&gt;
&lt;/div&gt; 



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Let's find the airport pickups...

.pull-left[

```r
nyc_taxi |&gt; 
  filter(
    pickup_location_id %in% airport_zones
  ) |&gt;
  select(
    matches("datetime"), 
    matches("location_id")
  )
```
]

--

.pull-right[

```
## FileSystemDataset (query)
## pickup_datetime: timestamp[ms]
## dropoff_datetime: timestamp[ms]
## pickup_location_id: int64
## dropoff_location_id: int64
## 
## * Filter: is_in(pickup_location_id, {value_set=int32:[
##   1,
##   132,
##   138
## ], skip_nulls=true})
## See $.data for the source Arrow object
```
]

&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## We need to use database joins

.pull-left[

```r
nyc_taxi |&gt; 
  filter(
    pickup_location_id %in% airport_zones
  ) |&gt;
  select(
    matches("datetime"), 
    matches("location_id")
  ) |&gt; 
  left_join(
    nyc_taxi_zones,
    by = c(
      "dropoff_location_id" = "location_id"
    )
  )
```
]
--
.pull-right[
.scroll-output[

```
## FileSystemDataset (query)
## pickup_datetime: timestamp[ms]
## dropoff_datetime: timestamp[ms]
## pickup_location_id: int64
## dropoff_location_id: int64
## borough: string
## zone: string
## service_zone: string
## 
## See $.data for the source Arrow object
```
]
]

&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## We need to use database joins

.pull-left[

```r
nyc_taxi |&gt; 
  filter(
    pickup_location_id %in% airport_zones
  ) |&gt;
  select(
    matches("datetime"), 
    matches("location_id")
  ) |&gt; 
  left_join(
    nyc_taxi_zones,
    by = c(
      "dropoff_location_id" = "location_id"
    )
  ) |&gt;
  collect()
```
]


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Wait... why does the join throw an error?

.pull-left[

```r
nyc_taxi |&gt; 
  filter(
    pickup_location_id %in% airport_zones
  ) |&gt;
  select(
    matches("datetime"), 
    matches("location_id")
  ) |&gt; 
  left_join(
    nyc_taxi_zones,
    by = c(
      "dropoff_location_id" = "location_id"
    )
  ) |&gt;
  collect()
```
]

.pull-right[
.scroll-output[

```
## Error in `collect()`:
## ! Invalid: Incompatible data types for corresponding join field keys: FieldRef.Name(dropoff_location_id) of type int64 and FieldRef.Name(location_id) of type int32
```
]
]

&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Wait... why does the join throw an error?

.pull-left[

```r
nyc_taxi |&gt; 
  filter(
    pickup_location_id %in% airport_zones
  ) |&gt;
  select(
    matches("datetime"), 
    matches("location_id")
  ) |&gt; 
  left_join(
    nyc_taxi_zones,
    by = c(
      "dropoff_location_id" = "location_id"
    )
  ) |&gt;
  collect()
```
]

.pull-right[
- `location_id`: 
    - 32-bit integer
- `dropoff_location_id`: 
    - 64-bit integer
- Needs to be handled explicitly
- May be new to some R users
]




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Solution: use schemas

- The problem:

  - Data types in R and Arrow are not identical
  - The data import defaults in {arrow} are good but...
  - ... they don't always work 

--
  
- The solution:  

  - Schemas describe types for each variable
  - User supplies types explicitly


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Solution: use schemas

.pull-left[

```r
schema(
  dropoff_location_id = int64(),
  dropoff_borough = utf8(),
  dropoff_zone = utf8()
)
```

```
## Schema
## dropoff_location_id: int64
## dropoff_borough: string
## dropoff_zone: string
```
]




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Solution: use schemas

.pull-left[

```r
nyc_taxi_zones_2 &lt;- nyc_taxi_zones |&gt;
  transmute(
    dropoff_location_id = location_id, 
    dropoff_borough = borough,
    dropoff_zone = zone) |&gt;
  as_arrow_table(
    schema = schema(
      dropoff_location_id = int64(),
      dropoff_borough = utf8(),
      dropoff_zone = utf8()
    )
  )

nyc_taxi_zones_2
```
]
--
.pull-right[
.scroll-output[

```
## Table
## 265 rows x 3 columns
## $dropoff_location_id &lt;int64&gt;
## $dropoff_borough &lt;string&gt;
## $dropoff_zone &lt;string&gt;
```
]
]





&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Now it all works...

.pull-left[

```r
nyc_taxi |&gt; 
  filter(
    pickup_location_id %in% airport_zones
  ) |&gt;
  select(
    matches("datetime"), 
    matches("location_id")
  ) |&gt; 
  left_join(nyc_taxi_zones_2) |&gt;
  collect()
```
]
--
.pull-right[
.scroll-output[

```
## # A tibble: 22,228,736 × 6
##    pickup_datetime     dropoff_datetime    pickup_location_id dropoff_location_…
##    &lt;dttm&gt;              &lt;dttm&gt;                           &lt;int&gt;              &lt;int&gt;
##  1 2016-10-01 21:25:28 2016-10-01 22:12:36                132                142
##  2 2016-10-01 21:25:31 2016-10-01 21:54:12                132                  7
##  3 2016-10-01 21:25:38 2016-10-01 21:54:09                138                181
##  4 2016-10-01 21:25:44 2016-10-01 21:53:04                138                 17
##  5 2016-10-01 21:25:47 2016-10-01 22:46:14                132                162
##  6 2016-10-01 21:25:48 2016-10-01 22:22:16                132                230
##  7 2016-10-01 21:25:53 2016-10-01 22:11:04                132                  4
##  8 2016-10-01 21:26:04 2016-10-01 21:39:15                138                 56
##  9 2016-10-01 21:26:15 2016-10-01 22:10:25                132                 25
## 10 2016-10-01 21:26:18 2016-10-01 21:46:38                138                132
## # … with 22,228,726 more rows, and 2 more variables: dropoff_borough &lt;chr&gt;,
## #   dropoff_zone &lt;chr&gt;
```
]
]



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-light-minimal
background-image: url("img/chris-lawton-5IHz5WhosQE-unsplash.jpg")
background-size: cover
background-repeat: no-repeat
background-position: left

## Step 4: Summarize

&lt;div class="my-footer"&gt;
&lt;span&gt;
&lt;a style="color:#f97b64; background-color: #22222288; padding: 5px" href="https://unsplash.com/photos/5IHz5WhosQE"&gt;&lt;b&gt;Image freely available courtesy of Chris Lawton, via Unsplash&lt;/b&gt;&lt;/a&gt;
&lt;/span&gt;
&lt;/div&gt; 



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Our query so far

.pull-left[

```r
nyc_taxi |&gt; 
  filter(
    pickup_location_id %in% airport_zones
  ) |&gt;
  select(
    matches("datetime"), 
    matches("location_id")
  ) |&gt; 
  left_join(nyc_taxi_zones_2)
```
]




&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Count rides by dropoff zone

.pull-left[

```r
nyc_taxi_zone_counts &lt;- nyc_taxi |&gt; 
  filter(
    pickup_location_id %in% airport_zones
  ) |&gt;
  select(
    matches("datetime"), 
    matches("location_id")
  ) |&gt; 
  left_join(nyc_taxi_zones_2) |&gt;
  count(dropoff_zone) |&gt;
  arrange(desc(n)) |&gt;
  collect()
```
]


&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Count rides by dropoff zone

.pull-left[

```r
nyc_taxi_zone_counts &lt;- nyc_taxi |&gt; 
  filter(
    pickup_location_id %in% airport_zones
  ) |&gt;
  select(
    matches("datetime"), 
    matches("location_id")
  ) |&gt; 
  left_join(nyc_taxi_zones_2) |&gt;
  count(dropoff_zone) |&gt;
  arrange(desc(n)) |&gt;
  collect()

nyc_taxi_zone_counts
```
]

.pull-right[
.scroll-output[

```
## # A tibble: 262 × 2
##    dropoff_zone                    n
##    &lt;chr&gt;                       &lt;int&gt;
##  1 Times Sq/Theatre District 1068981
##  2 Midtown Center             691807
##  3 Midtown East               691641
##  4 JFK Airport                645621
##  5 Midtown South              551206
##  6 Clinton East               544932
##  7 Murray Hill                534570
##  8 Midtown North              515244
##  9 &lt;NA&gt;                       419348
## 10 LaGuardia Airport          307649
## # … with 252 more rows
```
]
]



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## (A tiny bit more work)

.pull-left-wide[

```r
dat &lt;- "data/taxi_zones/taxi_zones.shp" |&gt; 
  sf::read_sf() |&gt;
  janitor::clean_names() |&gt;
  left_join(nyc_taxi_zone_counts,
            by = c("zone" = "dropoff_zone")) 

pic &lt;- dat |&gt; 
  ggplot(aes(fill = n)) + 
  geom_sf() + 
  theme_void()
```
]

&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-light-minimal
background-image: url("img/airport_map.png")
background-size: cover
background-repeat: no-repeat
background-position: left

## Data visualization

&lt;!-- let's make this super pretty --&gt; 







&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-dark-maximal

## Getting a deeper understanding






&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## Where does the new R user go?

- Documentation: [arrow.apache.org/docs/r](https://arrow.apache.org/docs/r/)
- Cookbook: [arrow.apache.org/cookbook/r](https://arrow.apache.org/cookbook/r/)
- Resource list: [github.com/thisisnic/awesome-arrow-r](https://github.com/thisisnic/awesome-arrow-r/)



&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-green-minimal

## How can the Arrow community help?

- Looking at our docs from a new user perspective
- Putting together novice friendly tutorials
- Being visible and helpful where we can!






&lt;!----------------------------- SLIDE BREAK -----------------------------&gt;
---

class: theme-dark-maximal

## Making connections with data! 

.pull-left[
- Apache Arrow is cool
- Data wrangling in R is cool
- {arrow} brings them together
]

.pull-right[
&lt;ol class="fa-ul"&gt;
  &lt;li&gt;&lt;span class="fa-li"&gt;&lt;i class="fa fa-twitter"&gt;&lt;/i&gt;&lt;/span&gt;twitter.com/djnavarro&lt;/li&gt;
  &lt;li&gt;&lt;span class="fa-li"&gt;&lt;i class="fa fa-github"&gt;&lt;/i&gt;&lt;/span&gt;github.com/djnavarro&lt;/li&gt;
  &lt;li&gt;&lt;span class="fa-li"&gt;&lt;i class="fa fa-globe"&gt;&lt;/i&gt;&lt;/span&gt;djnavarro.net&lt;/li&gt;
&lt;/ol&gt;
]


    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "solarized-dark",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9",
"slideNumberFormat": "<div class=\"progress-bar-container\">\n  <div class=\"progress-bar\" style=\"width: calc((%current% - 1) / (%total% - 1)* 100%);\">\n  </div>\n</div>"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
